<!DOCTYPE html>
<meta charset="utf-8"/>
<title>Rider Demo Console</title>
<body>
<h2>Rider Demo Console</h2>

<section>
    <h3>Authentication</h3>
    <label>Email <input id="loginEmail" value="john.doe@example.com" size="25"/></label>
    <label>Password <input id="loginPassword" value="Password1!" type="password" size="15"/></label>
    <label>Profile
        <select id="loginProfile">
            <option value="rider" selected>Rider</option>
            <option value="driver">Driver</option>
        </select>
    </label>
    <button id="login">Login</button>
</section>

<section>
    <label>Base URL <input id="base" value="http://localhost:8080" size="30"/></label>
    <label>JWT <input id="jwt" value="PUT_RIDER_TOKEN_HERE" size="60"/></label>
    <button id="connect">Connect WS</button>
</section>

<section>
    <h3>State</h3>
    <label>Quote ID <input id="quoteId" size="38"/></label>
    <label>Ride Request ID <input id="requestId" size="8"/></label>
    <label>Ride ID <input id="rideId" size="8"/></label>
</section>

<section>
    <h3>Quote & Booking</h3>
    <label>Pickup Lat <input id="pickupLat" value="10.84290" size="10"/></label>
    <label>Pickup Lng <input id="pickupLng" value="106.81954" size="10"/></label>
    <label>Drop Lat <input id="dropLat" size="10"/></label>
    <label>Drop Lng <input id="dropLng" size="10"/></label>
    <label>Pickup Location ID <input id="pickupLocationId" size="4"/></label>
    <label>Drop Location ID <input id="dropLocationId" value="12" size="4"/></label>
    <label>Desired Pickup (ISO) <input id="desiredPickup" size="20"/></label>
    <button id="generateQuote">Generate Quote</button>
    <button id="createAiBooking">Create AI Booking</button>
</section>

<section>
    <h3>Join Existing Ride</h3>
    <label>Target Ride ID <input id="joinRideId" size="8"/></label>
    <button id="browseRides">Browse Available Rides</button>
    <button id="createJoinRequest">Create Join Request</button>
</section>

<section>
    <h3>Request Monitoring</h3>
    <button id="getRequest">Get Request Detail</button>
    <button id="cancelRequest">Cancel Request</button>
</section>

<section>
    <h3>Broadcast Marketplace</h3>
    <button id="listBroadcastingRequests">List Broadcasting Requests</button>
</section>

<section>
    <h3>SOS Alerts</h3>
    <label>Alert ID <input id="sosAlertId" size="8"/></label>
    <label>Alert Type
        <select id="sosAlertType">
            <option value="">(auto)</option>
            <option value="EMERGENCY">EMERGENCY</option>
            <option value="ACCIDENT">ACCIDENT</option>
            <option value="BREAKDOWN">BREAKDOWN</option>
            <option value="SAFETY_CONCERN">SAFETY_CONCERN</option>
            <option value="OTHER">OTHER</option>
        </select>
    </label>
    <label>Lat <input id="sosLat" value="10.84148" size="10"/></label>
    <label>Lng <input id="sosLng" value="106.809844" size="10"/></label>
    <label>Description <input id="sosDescription" value="Need assistance" size="40"/></label>
    <label><input type="checkbox" id="sosForceFallback"/> Force fallback call</label>
    <button id="triggerSos">Trigger SOS</button>
    <label>Status Filter <input id="sosStatusFilter" placeholder="ACTIVE,ESCALATED..." size="20"/></label>
    <button id="listMyAlerts">List My Alerts</button>
    <button id="getAlertDetail">Get Alert Detail</button>
    <button id="getAlertTimeline">Get Alert Timeline</button>
</section>

<section>
    <h3>Emergency Contacts</h3>
    <label>Contact ID <input id="contactId" size="8"/></label>
    <label>Name <input id="contactName" value="Mai Anh" size="15"/></label>
    <label>Phone <input id="contactPhone" value="+84901111222" size="15"/></label>
    <label>Relationship <input id="contactRelationship" value="Sister" size="10"/></label>
    <label><input type="checkbox" id="contactPrimary"/> Primary</label>
    <button id="listContacts">List Contacts</button>
    <button id="createContact">Create Contact</button>
    <button id="updateContact">Update Contact</button>
    <button id="setPrimaryContact">Set Primary</button>
    <button id="deleteContact">Delete Contact</button>
</section>

<pre id="log"></pre>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script>
    const $ = (id) => document.getElementById(id);
    const log = (msg) => $("log").textContent += `[${new Date().toISOString()}] ${msg}\n`;

    const state = {stomp: null};
    const parseFloatOrNull = (value) => {
        const num = parseFloat(value);
        return Number.isFinite(num) ? num : null;
    };
    const parseIntOrNull = (value) => {
        const num = parseInt(value, 10);
        return Number.isFinite(num) ? num : null;
    };
    const trimOrNull = (value) => {
        if (value === undefined || value === null) return null;
        const trimmed = String(value).trim();
        return trimmed.length ? trimmed : null;
    };

    async function api(path, method = "GET", body) {
        const base = $("base").value;
        const jwt = $("jwt").value.trim();
        const headers = {Authorization: "Bearer " + jwt};
        if (body !== undefined) headers["Content-Type"] = "application/json";
        const res = await fetch(base + path, {
            method,
            headers,
            body: body !== undefined ? JSON.stringify(body) : undefined,
        });
        const text = await res.text();
        let payload = null;
        try {
            payload = text ? JSON.parse(text) : null;
        } catch {
            payload = text;
        }
        log(`${method} ${path} -> ${res.status} ${text}`);
        return {res, payload};
    }

    // Function to handle subscribing to ride tracking
    let currentTrackingSubscription = null; // To keep track of the current subscription and unsubscribe if rideId changes
    function subscribeToRideTracking(rideId) {
        if (state.stomp && state.stomp.connected && rideId) {
            if (currentTrackingSubscription) {
                currentTrackingSubscription.unsubscribe(); // Unsubscribe from previous ride if any
            }
            currentTrackingSubscription = state.stomp.subscribe("/topic/ride.tracking." + rideId, (msg) => {
                log("Ride Tracking Update: " + msg.body);
            });
            log("Subscribed to ride tracking for ride ID: " + rideId);
        }
    }

    $("login").onclick = async () => {
        const body = {
            email: $("loginEmail").value,
            password: $("loginPassword").value,
            targetProfile: $("loginProfile").value,
        };
        const {res, payload} = await api("/api/v1/auth/login", "POST", body);
        if (res.ok && payload?.access_token) {
            $("jwt").value = payload.access_token;
            log("Login successful. Token populated.");
        } else {
            log("Login failed.");
        }
    };

    $("connect").onclick = () => {
        const base = $("base").value;
        const jwt = $("jwt").value.trim();
        const sock = new SockJS(base + "/ws?token=" + encodeURIComponent(jwt));
        state.stomp = Stomp.over(sock);
        state.stomp.connect(
            {Authorization: "Bearer " + jwt},
            () => {
                log("WebSocket connected");
                // Enhanced handler for ride-matching queue
                state.stomp.subscribe("/user/queue/ride-matching", (msg) => {
                    log("Ride matching: " + msg.body);
                    try {
                        const matchResult = JSON.parse(msg.body);
                        // If the match is accepted and contains a rideId, start tracking
                        if (matchResult.status === "ACCEPTED" && matchResult.rideId) {
                            $("rideId").value = matchResult.rideId; // Update UI
                            subscribeToRideTracking(matchResult.rideId);
                        }
                    } catch (e) {
                        log("Error parsing ride matching message: " + e.message);
                    }
                });
                state.stomp.subscribe("/user/queue/sos", (msg) => log("SOS: " + msg.body));

                state.stomp.subscribe("/user/queue/notifications", (msg) => {
                    log("Notification: " + msg.body);
                    try {
                        const notification = JSON.parse(msg.body);
                        if (notification.type === "RIDE_CONFIRMED" || notification.type === "RIDE_STARTED") {
                            const payload = JSON.parse(notification.payload);
                            if (payload && payload.rideId) {
                                $("rideId").value = payload.rideId;
                                subscribeToRideTracking(payload.rideId);
                            }
                        }
                    } catch (e) {
                        log("Error parsing notification or payload: " + e.message);
                    }
                });
            },
            (err) => log("WS error: " + err)
        );
    };


    $("generateQuote").onclick = async () => {
        const body = {
            pickup: {latitude: parseFloat($("pickupLat").value), longitude: parseFloat($("pickupLng").value)},
            dropoff: {latitude: parseFloat($("dropLat").value), longitude: parseFloat($("dropLng").value)},
            pickupLocationId: parseInt($("pickupLocationId").value, 10),
            dropoffLocationId: parseInt($("dropLocationId").value, 10),
        };
        const {payload} = await api("/api/v1/quotes", "POST", body);
        if (payload?.id || payload?.quoteId) {
            const quoteId = payload.id ?? payload.quoteId;
            $("quoteId").value = quoteId;
            log("Quote stored: " + quoteId);
        }
    };

    $("createAiBooking").onclick = async () => {
        const quoteId = $("quoteId").value.trim();
        if (!quoteId) return log("Quote ID required.");
        const desiredPickup = $("desiredPickup").value || null;
        const body = {
            quoteId,
            desiredPickupTime: desiredPickup,
            notes: "Helmet please",
        };
        const {payload} = await api("/api/v1/ride-requests", "POST", body);
        if (payload?.sharedRideRequestId) {
            $("requestId").value = payload.sharedRideRequestId;
            log("AI booking created: " + payload.sharedRideRequestId);
        }
    };

    $("browseRides").onclick = async () => {
        const start = new Date(Date.now() - 15 * 60 * 1000).toISOString().split(".")[0];
        const end = new Date(Date.now() + 60 * 60 * 1000).toISOString().split(".")[0];
        const {payload} = await api(`/api/v1/rides/available?startTime=${start}&endTime=${end}&page=0&pageSize=5`);
        if (payload?.data?.length) {
            const ride = payload.data[0];
            $("joinRideId").value = ride.sharedRideId;
            log("Loaded ride " + ride.sharedRideId + " into Target Ride ID");
        }
    };

    $("createJoinRequest").onclick = async () => {
        const rideId = $("joinRideId").value;
        const quoteId = $("quoteId").value.trim();
        if (!rideId || !quoteId) return log("Ride ID and Quote ID required.");
        const body = {
            quoteId,
            desiredPickupTime: $("desiredPickup").value || null,
            notes: "Joining via console",
        };
        const {payload} = await api(`/api/v1/ride-requests/rides/${rideId}`, "POST", body);
        if (payload?.sharedRideRequestId) {
            $("requestId").value = payload.sharedRideRequestId;
            log("Join request created: " + payload.sharedRideRequestId);
            $("rideId").value = rideId; // Update UI with the rideId
            subscribeToRideTracking(rideId); // Subscribe to tracking for this ride
        }
    };

    $("getRequest").onclick = async () => {
        const reqId = $("requestId").value;
        if (!reqId) return log("Request ID required.");
        await api(`/api/v1/ride-requests/${reqId}`);
    };

    $("cancelRequest").onclick = async () => {
        const reqId = $("requestId").value;
        if (!reqId) return log("Request ID required.");
        await api(`/api/v1/ride-requests/${reqId}`, "DELETE");
    };

    $("listBroadcastingRequests").onclick = async () => {
        await api("/api/v1/ride-requests/broadcasting");
    };

    $("triggerSos").onclick = async () => {
        const body = {
            sharedRideId: parseIntOrNull($("rideId").value),
            currentLat: parseFloatOrNull($("sosLat").value),
            currentLng: parseFloatOrNull($("sosLng").value),
            description: trimOrNull($("sosDescription").value),
            forceFallbackCall: $("sosForceFallback").checked,
        };
        const type = $("sosAlertType").value;
        if (type) body.alertType = type;
        const {payload} = await api("/api/v1/sos/alerts", "POST", body);
        if (payload?.sosId) {
            $("sosAlertId").value = payload.sosId;
            log("SOS alert created: " + payload.sosId);
        }
    };

    $("listMyAlerts").onclick = async () => {
        const status = trimOrNull($("sosStatusFilter").value);
        const query = status ? `?status=${encodeURIComponent(status)}` : "";
        await api(`/api/v1/sos/alerts/me${query}`);
    };

    $("getAlertDetail").onclick = async () => {
        const alertId = $("sosAlertId").value.trim();
        if (!alertId) return log("Alert ID required.");
        await api(`/api/v1/sos/alerts/${alertId}`);
    };

    $("getAlertTimeline").onclick = async () => {
        const alertId = $("sosAlertId").value.trim();
        if (!alertId) return log("Alert ID required.");
        await api(`/api/v1/sos/alerts/${alertId}/timeline`);
    };

    $("listContacts").onclick = async () => {
        const {payload} = await api("/api/v1/sos/contacts");
        if (Array.isArray(payload) && payload.length) {
            const primary = payload.find((c) => c.primary) ?? payload[0];
            $("contactId").value = primary.contactId;
            $("contactName").value = primary.name;
            $("contactPhone").value = primary.phone;
            $("contactRelationship").value = primary.relationship ?? "";
            $("contactPrimary").checked = Boolean(primary.primary);
        }
    };

    $("createContact").onclick = async () => {
        const body = {
            name: trimOrNull($("contactName").value),
            phone: trimOrNull($("contactPhone").value),
            relationship: trimOrNull($("contactRelationship").value),
            primary: $("contactPrimary").checked,
        };
        const {payload} = await api("/api/v1/sos/contacts", "POST", body);
        if (payload?.contactId) {
            $("contactId").value = payload.contactId;
            log("Contact created: " + payload.contactId);
        }
    };

    $("updateContact").onclick = async () => {
        const contactId = $("contactId").value.trim();
        if (!contactId) return log("Contact ID required.");
        const body = {
            name: trimOrNull($("contactName").value),
            phone: trimOrNull($("contactPhone").value),
            relationship: trimOrNull($("contactRelationship").value),
            primary: $("contactPrimary").checked,
        };
        await api(`/api/v1/sos/contacts/${contactId}`, "PUT", body);
    };

    $("setPrimaryContact").onclick = async () => {
        const contactId = $("contactId").value.trim();
        if (!contactId) return log("Contact ID required.");
        await api(`/api/v1/sos/contacts/${contactId}/primary`, "POST");
        $("contactPrimary").checked = true;
    };

    $("deleteContact").onclick = async () => {
        const contactId = $("contactId").value.trim();
        if (!contactId) return log("Contact ID required.");
        await api(`/api/v1/sos/contacts/${contactId}`, "DELETE");
    };
</script>
</body>
